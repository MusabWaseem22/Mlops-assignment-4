name: Data Extraction
description: 'Extract data from DVC remote storage using dvc get or dvc import.

  This component fetches a versioned dataset from DVC remote storage.
  It uses DVC''s get/import functionality to retrieve the data.'

inputs:
- {name: dvc_remote_url, type: String, description: 'URL or path to DVC remote storage
    (e.g., ''../dvc-storage'' or ''gdrive://folder-id'')'}
- {name: data_path, type: String, description: 'Path to the data file in DVC (e.g.,
    ''data/raw/raw_data.csv'')'}
- {name: output_data_path, type: String, description: 'Path where the extracted data
    will be saved'}

outputs:
- {name: Output, type: String, description: 'Path to the extracted data file'}

implementation:
  container:
    image: python:3.9
    command:
    - sh
    - -c
    - |
      set -e
      python3 -m pip install --quiet --no-warn-script-location dvc[s3]>=3.0.0 pandas>=2.0.0 || pip3 install --quiet --no-warn-script-location dvc[s3]>=3.0.0 pandas>=2.0.0 || pip install --quiet --no-warn-script-location dvc[s3]>=3.0.0 pandas>=2.0.0
      "$0" "$@"
    - |
      def data_extraction(dvc_remote_url, data_path, output_data_path):
          import subprocess
          import os
          from pathlib import Path
          
          print(f"Starting data extraction from DVC...")
          print(f"Remote URL: {dvc_remote_url}")
          print(f"Data path: {data_path}")
          print(f"Output path: {output_data_path}")
          
          output_dir = os.path.dirname(output_data_path)
          if output_dir:
              os.makedirs(output_dir, exist_ok=True)
          
          try:
              cmd = [
                  'python', '-m', 'dvc', 'get',
                  '--remote', dvc_remote_url,
                  '.',
                  data_path,
                  '-o', output_data_path
              ]
              
              result = subprocess.run(
                  cmd,
                  capture_output=True,
                  text=True,
                  check=True
              )
              print(f"Data extraction successful!")
          except subprocess.CalledProcessError as e:
              if os.path.exists(data_path):
                  import shutil
                  shutil.copy(data_path, output_data_path)
                  print(f"Copied data from local path: {data_path}")
              else:
                  raise Exception(f"Failed to extract data: {e.stderr}")
          
          if not os.path.exists(output_data_path):
              raise FileNotFoundError(f"Output file not created: {output_data_path}")
          
          return output_data_path
      
      import json
      import os
      _outputs = {}
      _outputs['Output'] = data_extraction(
          dvc_remote_url=json.loads(r'''$0'''),
          data_path=json.loads(r'''$1'''),
          output_data_path=json.loads(r'''$2''')
      )
      os.makedirs('$3', exist_ok=True)
      with open(os.path.join('$3', 'Output'), 'w') as f:
          f.write(str(_outputs['Output']))
    - {inputValue: dvc_remote_url}
    - {inputValue: data_path}
    - {inputValue: output_data_path}
    - {outputPath: Output}

