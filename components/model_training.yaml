name: Model Training
description: 'Train a Random Forest model on the training data and save the model artifact.

  This component trains a RandomForestRegressor on the preprocessed training data
  and saves the trained model as a joblib file.'

inputs:
- {name: train_data_path, type: String, description: 'Path to the preprocessed training
    data CSV file'}
- {name: model_output_path, type: String, description: 'Path to save the trained
    model artifact (joblib format)'}
- {name: n_estimators, type: Integer, default: '100', description: 'Number of trees
    in the Random Forest'}
- {name: max_depth, type: Integer, default: '0', description: 'Maximum depth of the
    trees (0 = unlimited)'}
- {name: min_samples_split, type: Integer, default: '2', description: 'Minimum samples
    required to split a node'}
- {name: random_state, type: Integer, default: '42', description: 'Random state for
    reproducibility'}

outputs:
- {name: Output, type: String, description: 'Path to the saved model artifact'}

implementation:
  container:
    image: python:3.9
    command:
    - sh
    - -c
    - |
      set -e
      python3 -m pip install --quiet --no-warn-script-location pandas>=2.0.0 numpy>=1.24.0 scikit-learn>=1.3.0 joblib>=1.3.0 || pip3 install --quiet --no-warn-script-location pandas>=2.0.0 numpy>=1.24.0 scikit-learn>=1.3.0 joblib>=1.3.0 || pip install --quiet --no-warn-script-location pandas>=2.0.0 numpy>=1.24.0 scikit-learn>=1.3.0 joblib>=1.3.0
      "$0" "$@"
    - |
      def model_training(train_data_path, model_output_path, n_estimators, max_depth, min_samples_split, random_state):
          import pandas as pd
          import numpy as np
          import joblib
          from sklearn.ensemble import RandomForestRegressor
          import os
          
          train_df = pd.read_csv(train_data_path)
          X_train = train_df.drop(['target', 'split'], axis=1)
          y_train = train_df['target']
          
          max_depth_param = None if max_depth == 0 else max_depth
          
          rf_model = RandomForestRegressor(
              n_estimators=n_estimators,
              max_depth=max_depth_param,
              min_samples_split=min_samples_split,
              random_state=random_state,
              n_jobs=-1,
              verbose=1
          )
          
          rf_model.fit(X_train, y_train)
          
          os.makedirs(os.path.dirname(model_output_path), exist_ok=True)
          joblib.dump(rf_model, model_output_path)
          
          return model_output_path
      
      import json
      import os
      _outputs = {}
      _outputs['Output'] = model_training(
          train_data_path=json.loads(r'''$0'''),
          model_output_path=json.loads(r'''$1'''),
          n_estimators=int(json.loads(r'''$2''')),
          max_depth=int(json.loads(r'''$3''')),
          min_samples_split=int(json.loads(r'''$4''')),
          random_state=int(json.loads(r'''$5'''))
      )
      os.makedirs('$6', exist_ok=True)
      with open(os.path.join('$6', 'Output'), 'w') as f:
          f.write(str(_outputs['Output']))
    - {inputValue: train_data_path}
    - {inputValue: model_output_path}
    - {inputValue: n_estimators}
    - {inputValue: max_depth}
    - {inputValue: min_samples_split}
    - {inputValue: random_state}
    - {outputPath: Output}

